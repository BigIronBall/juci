#!/usr/bin/lua

local juci = require("juci/core"); 

local function backup_restore(opts)
	local res = {}; 
	local pass = ""; 
	if(opts.password ~= "" and opts.password ~= nil) then 
		local decrypt = juci.shell('openssl des3 -d -in /tmp/backup.tar.gz -out /tmp/backup.tar.gz.dec -pass pass:"%s"; mv /tmp/backup.tar.gz.dec /tmp/backup.tar.gz', opts.password); 
		res["decrypt"] = decrypt; 
	end
	res["stdout"] = juci.shell("sysupgrade --restore-backup /tmp/backup.tar.gz"); 
	print(json.encode(res)); 
end

local function backup_clean()
	local res = {}; 
	res["stdout"] = juci.shell("sysupgrade --clean"); 
	print(json.encode(res)); 
end

local function backup_get_features()
	local res = { }; 
	if("" ~= juci.shell("openssl version")) then res.encryption = true; else res.encryption = false end
	res.comment = false; 
	print(json.encode(res)); 
end

juci.ubus({
	["restore"] = backup_restore, 
	["features"] = backup_get_features, 
	["clean"] = backup_clean
}, arg); 

