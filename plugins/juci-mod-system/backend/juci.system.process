#!/usr/bin/lua

require("JUCI"); 

function fields(inputstr, sep)
	if sep == nil then
					sep = "%s"
	end
	local t={} ; i=1
	for str in string.gmatch(inputstr, "([^"..sep.."]+)") do
					t[i] = str
					i = i + 1
	end
	return t
end

function process_list()
	local res = {}; 
	local lines = {}; 
	res["list"] = lines; 
	local stdout = juci.shell("top -bn1"); 
	for line in stdout:gmatch("[^\r\n]+") do 
		local arr = fields(line, "%s"); 
		local obj = {
			["pid"] = arr[0], 
			["parent"] = arr[1], 
			["user"] = arr[2], 
			["status"] = arr[3],
			["vsz"] = arr[4],
			["cpu"] = arr[6],
			["command"] = arr[7]
		};  
		table.insert(lines, obj); 
	end
	print(json.encode(res)); 
end

juci.ubus({
	["list"] = process_list
}, arg); 
