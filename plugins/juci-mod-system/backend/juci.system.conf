#!/usr/bin/lua

require("JSON"); 

function shell(cmd)
	local p = assert(io.popen(cmd)); 
	local s = p:read("*a"); 
	p:close(); 
	return s; 
end

function backup_restore(opts)
	local res = {}; 
	local pass = ""; 
	if(opts["password"]) then pass = "--password "..opts["password"]; end
	res["stdout"] = shell("sysupgrade --restore-backup /tmp/backup.tar.gz "..pass); 
	print(json.encode(res)); 
end

function backup_clean()
	local res = {}; 
	res["stdout"] = shell("sysupgrade --clean"); 
	print(json.encode(res)); 
end

local _calls = {
	["restore"] = backup_restore, 
	["clean"] = backup_clean, 
	["list"] = backup_list
}; 

if arg[1] == ".methods" then 
	print("restore,clean,list");
elseif _calls[arg[1]] then 
	local params = {}; 
	if arg[2] then params = json.decode(arg[2]); end
	_calls[arg[1]](params); 
else 
	io.write("Unknown method!\n"); 
end

